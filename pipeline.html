<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pipeline | DealPilot</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/supabaseClient.js"></script>
<script src="assets/gate.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    window.DealPilotGate.requirePremium();
  });
</script>
</head>
<body>

<div class="nav" id="siteNav">
  <div class="container">
    <div class="nav-inner">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <div>DealPilot</div>
      </a>
      <button class="menu-btn" id="menuBtn" aria-label="Open menu">☰</button>
      <div class="nav-links">
        <a href="analyzer.html">Analyzer</a>
        <a href="pipeline.html" style="color:var(--text); background:rgba(255,255,255,.05);">Pipeline</a>
        <a href="tools.html">Premium Tools</a>
        <a href="pricing.html">Pricing</a>
        <a href="login.html">Login</a>
      </div>
    </div>
  </div>
</div>

<div class="section">
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin:0;">Pipeline</h2>
        <p style="margin:0; color:var(--muted);">Drag deals through your wholesaling workflow.</p>
      </div>
      <button class="btn primary" id="addDealBtn">+ Add Deal</button>
    </div>

    <div style="height:14px"></div>
    <div id="board" class="kanban"></div>
  </div>
</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop"></div>
<div id="modal" class="modal">
  <div class="card pad">
    <h2 id="modalTitle">Add Deal</h2>
    <form id="form" class="form">

      <input type="hidden" id="id">

      <div style="grid-column:1/-1">
        <label>Address</label>
        <input id="address" required>
      </div>

      <div>
        <label>Stage</label>
        <select id="stage">
          <option value="LEADS">Leads</option>
          <option value="MARKETING">Marketing</option>
          <option value="UNDER_CONTRACT">Under Contract</option>
          <option value="CLOSED">Assigned / Closed</option>
          <option value="DEAD">Dead</option>
        </select>
      </div>

      <div>
        <label>ARV</label>
        <input id="arv" type="number">
      </div>

      <div>
        <label>Repairs</label>
        <input id="repairs" type="number">
      </div>

      <div>
        <label>Your Offer</label>
        <input id="offer" type="number">
      </div>

      <div>
        <label>Assignment</label>
        <input id="assignment" type="number" value="10000">
      </div>

      <div style="grid-column:1/-1">
        <label>Notes</label>
        <input id="notes">
      </div>

      <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" class="btn" id="deleteBtn" style="display:none;">Delete</button>
        <button class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<style>
.kanban{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:16px}
@media(max-width:1100px){.kanban{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.kanban{grid-template-columns:1fr}}

.column{border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.03)}
.col-head{padding:10px;border-bottom:1px solid var(--border);font-weight:700}
.drop{padding:10px;min-height:120px;display:flex;flex-direction:column;gap:8px}

.card-deal{border:1px solid var(--border);border-radius:12px;padding:10px;background:rgba(11,15,23,.6)}
.card-deal small{color:var(--muted)}
.actions{display:flex;gap:6px;margin-top:8px}
.actions button{font-size:12px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none}
.modal{position:fixed;top:40px;left:0;right:0;max-width:800px;margin:auto;display:none}
</style>

<script>
const KEY="dealpilot_pipeline_v2";
const STAGES=[
  ["LEADS","Leads"],
  ["MARKETING","Marketing"],
  ["UNDER_CONTRACT","Under Contract"],
  ["CLOSED","Assigned / Closed"],
  ["DEAD","Dead"]
];

let deals=JSON.parse(localStorage.getItem(KEY)||"[]");

const board=document.getElementById("board");
const modal=document.getElementById("modal");
const backdrop=document.getElementById("backdrop");
const form=document.getElementById("form");
const deleteBtn=document.getElementById("deleteBtn");

function save(){localStorage.setItem(KEY,JSON.stringify(deals))}
function uid(){return crypto.randomUUID()}

function openModal(d=null){
  modal.style.display="block";
  backdrop.style.display="block";
  deleteBtn.style.display=d?"inline-flex":"none";
  form.id.value=d?.id||"";
  address.value=d?.address||"";
  stage.value=d?.stage||"LEADS";
  arv.value=d?.arv||"";
  repairs.value=d?.repairs||"";
  offer.value=d?.offer||"";
  assignment.value=d?.assignment||10000;
  notes.value=d?.notes||"";
}

function closeModal(){
  modal.style.display="none";
  backdrop.style.display="none";
  form.reset();
}

function mao(d){return d.arv*0.7-d.repairs-d.assignment}
function money(n){return "$"+Number(n||0).toLocaleString()}

function render(){
  board.innerHTML="";
  STAGES.forEach(([key,label])=>{
    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`<div class="col-head">${label}</div>`;
    const drop=document.createElement("div");
    drop.className="drop";
    drop.ondragover=e=>e.preventDefault();
    drop.ondrop=e=>{
      const id=e.dataTransfer.getData("id");
      const d=deals.find(x=>x.id===id);
      d.stage=key; save(); render();
    };
    deals.filter(d=>d.stage===key).forEach(d=>{
      const c=document.createElement("div");
      c.className="card-deal";
      c.draggable=true;
      c.ondragstart=e=>e.dataTransfer.setData("id",d.id);
      c.innerHTML=`
        <b>${d.address}</b>
        <small>${money(d.offer)} → MAO ${money(mao(d))}</small>
        <div class="actions">
          <button class="btn" data-edit>Edit</button>
          <button class="btn" data-dispo>Dispo</button>
        </div>`;
      c.querySelector("[data-edit]").onclick=()=>openModal(d);
      c.querySelector("[data-dispo]").onclick=()=>{
        const q=new URLSearchParams({
          address:d.address,
          arv:d.arv,
          ask:d.offer,
          repairs:d.repairs,
          notes:d.notes
        });
        window.open("tool-dispo.html?"+q.toString(),"_blank");
      };
      drop.appendChild(c);
    });
    col.appendChild(drop);
    board.appendChild(col);
  });
}

document.getElementById("addDealBtn").onclick=()=>openModal();
backdrop.onclick=closeModal;

form.onsubmit=e=>{
  e.preventDefault();
  const d={
    id:form.id.value||uid(),
    address:address.value,
    stage:stage.value,
    arv:+arv.value||0,
    repairs:+repairs.value||0,
    offer:+offer.value||0,
    assignment:+assignment.value||0,
    notes:notes.value
  };
  const i=deals.findIndex(x=>x.id===d.id);
  i>=0?deals[i]=d:deals.unshift(d);
  save(); closeModal(); render();
};

deleteBtn.onclick=()=>{
  deals=deals.filter(d=>d.id!==form.id.value);
  save(); closeModal(); render();
};

render();
</script>
<script src="assets/nav.js"></script>
</body>
</html>
